<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="dist/css/161125322007.css">
</head>
<body>
<h1 class="text-center my-5">ç”µè´¹è®¡ç®—å™¨</h1>
<!-- åº•éƒ¨ Canvas ä¿æŒä¸å˜ -->
<div class="container result-table">
    <div style="position: relative; width: 100%; height: 400px;">
        <canvas id="energyChart"></canvas>
    </div>
</div>
<br>
<div class="container">
    <div id="electricityTable"></div>
</div>
<br>
<!-- â†“â†“â†“ æ–°å¢ï¼šæµ‹è¯•ç”¨â€œæ·»åŠ è´¦å•â€è¡¨å• â†“â†“â†“ -->
<div class="container result-table">
    <h4>æ·»åŠ æµ‹è¯•è´¦å•</h4>
    <form id="addPeriodForm">
        <div class="row mb-3">
            <div class="col">
                <label for="billingDate" class="form-label">å¸å•æ—¥æœŸ</label>
                <input type="text" class="form-control" id="billingDate" name="billingDate" placeholder="YYYY-MM-DD"
                       value="2088-08-08" required>
            </div>
            <div class="col">
                <label for="totalPaid" class="form-label">ç”µè´¹æ€»é¢ï¼ˆï¿¥ï¼‰</label>
                <input type="number" step="0.01" class="form-control" id="totalPaid" name="totalPaid" value="500"
                       required>
            </div>
        </div>
        <!-- å››ä¸ªç”µè¡¨çš„å½•å…¥è¡Œ -->
        <div class="row mb-3">
            <div class="col-auto align-self-center">
                <span>1å·è¡¨ï¼š</span>
            </div>
            <div class="col">
                <input type="number" step="0.1" class="form-control" name="m1Reading" placeholder="æœ¬æœŸè¯»æ•°"
                       value="8500" required>
            </div>
            <div class="col-auto align-self-center">
                <span>äººæ•°ï¼š</span>
            </div>
            <div class="col">
                <input type="number" class="form-control" name="m1Count" placeholder="å…¬æ‘Šäººæ•°" value="1" required>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-auto align-self-center">
                <span>2å·è¡¨ï¼š</span>
            </div>
            <div class="col">
                <input type="number" step="0.1" class="form-control" name="m2Reading" placeholder="æœ¬æœŸè¯»æ•°"
                       value="10500" required>
            </div>
            <div class="col-auto align-self-center">
                <span>äººæ•°ï¼š</span>
            </div>
            <div class="col">
                <input type="number" class="form-control" name="m2Count" placeholder="å…¬æ‘Šäººæ•°" value="1" required>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-auto align-self-center">
                <span>3å·è¡¨ï¼š</span>
            </div>
            <div class="col">
                <input type="number" step="0.1" class="form-control" name="m3Reading" placeholder="æœ¬æœŸè¯»æ•°"
                       value="8400" required>
            </div>
            <div class="col-auto align-self-center">
                <span>äººæ•°ï¼š</span>
            </div>
            <div class="col">
                <input type="number" class="form-control" name="m3Count" placeholder="å…¬æ‘Šäººæ•°" value="2" required>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-auto align-self-center">
                <span>4å·è¡¨ï¼š</span>
            </div>
            <div class="col">
                <input type="number" step="0.1" class="form-control" name="m4Reading" placeholder="æœ¬æœŸè¯»æ•°"
                       value="6400" required>
            </div>
            <div class="col-auto align-self-center">
                <span>äººæ•°ï¼š</span>
            </div>
            <div class="col">
                <input type="number" class="form-control" name="m4Count" placeholder="å…¬æ‘Šäººæ•°" value="1" required>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col">
                <label for="priceTier" class="form-label">å•ä»·æ¡£ä½</label>
                <select class="form-select" id="priceTier" name="priceTier" required>
                    <option value="1">ç¬¬ä¸€æ¡£ï¼ˆï¿¥0.617/åº¦ï¼‰</option>
                    <option value="2">ç¬¬äºŒæ¡£ï¼ˆï¿¥0.667/åº¦ï¼‰</option>
                    <option value="3" selected>ç¬¬ä¸‰æ¡£ï¼ˆï¿¥0.917/åº¦ï¼‰</option>
                </select>
                <div class="form-text">æ³¨ï¼š2025-07-18ï¼ˆå«ï¼‰ä¹‹å‰çš„è´¦å•ä»æŒ‰ï¿¥0.600/åº¦è®¡ç®—ã€‚</div>
            </div>
        </div>
        <!-- åŸæœ‰çš„æäº¤æŒ‰é’® -->
        <button type="submit" class="btn btn-success">æ·»åŠ è´¦å•å¹¶æµ‹ç®—â†‘</button>
        <!-- æ–°å¢ï¼šä¸‹è½½å…ƒæ•°æ®æŒ‰é’® -->
        <button type="button"
                class="btn btn-secondary ms-2"
                id="downloadDataBtn">
            ä¸‹è½½å…ƒæ•°æ®â†“
        </button>
    </form>
</div>

<script src="dist/js/jquery-3.7.0.min.js"></script>
<script src="dist/js/bootstrap.js"></script>
<script src="dist/js/bootstrap.bundle.min.js"></script>
<script src="data/billingPeriods.js"></script>
<script src="dist/chart.min.js"></script>
<script>
    // æ¡£ä½ä»·æ ¼æ˜ å°„
    const TIER_PRICE_MAP = {1: 0.617, 2: 0.667, 3: 0.917};

    /**
     * è®¡ç®—æœ¬æœŸå•ä»·ï¼š
     * - 2025-07-18ï¼ˆå«ï¼‰ä¹‹å‰ï¼šå›ºå®š 0.600
     * - ä¹‹åï¼šæŒ‰ period.tierï¼ˆç¬¬1/2/3æ¡£ï¼‰å†³å®šå•ä»·ï¼›å¦‚ç¼ºçœåˆ™é»˜è®¤æŒ‰ç¬¬3æ¡£ä»¥ä¿æŒä¸ä½ ç°æœ‰ç»“æœä¸€è‡´
     * è¿”å›ï¼š{ unitPrice, tierLabel, tier }
     */
    function getUnitPrice(period) {
        const cutoff = new Date('2025-07-18');
        const billDate = new Date(period.billingPeriodDate);
        const t = period.tier; // é»˜è®¤ç¬¬3æ¡£ä»¥å…¼å®¹æ—§æ•°æ®
        let tierLabel;
        if (billDate <= cutoff) {
            return {unitPrice: 0.600, tierLabel: "ä¸€", tier: t};
        }
        if (t == 1) {
            tierLabel = "ä¸€";
        } else if (t == 2) {
            tierLabel = "äºŒ";
        } else {
            tierLabel = "ä¸‰";
        }
        return {unitPrice: TIER_PRICE_MAP[t], tierLabel: tierLabel, tier: t};
    }

    // æ¸²æŸ“ç”µè´¹è¡¨æ ¼
    function renderElectricityTable() {
        const container = document.getElementById('electricityTable');
        container.innerHTML = '';

        billingPeriods.forEach((currentPeriod, idx) => {
            const {unitPrice, tierLabel, tier} = getUnitPrice(currentPeriod);

            // è·³è¿‡æœ€åä¸€æœŸï¼Œå› ä¸ºæ— æ³•å†ä¸ºå®ƒè§£æ[ä¸ŠæœŸæ•°æ®]
            if (idx === billingPeriods.length - 1) {
                return;
            }
            // æ„å»ºä¸ŠæœŸè¯»æ•°æ˜ å°„ï¼Œæ•°æ®ç»“æ„ï¼š{1å·è¡¨: 5337.5, 2å·è¡¨: 7995.4, 3å·è¡¨: 10008.2, 4å·è¡¨: 7904.9}
            const previousPeriod = billingPeriods[idx + 1];
            const previousReadingMap = {};
            previousPeriod.meters.forEach(m => {
                previousReadingMap[m.meterId] = m.currentReading;
            });
            // ä¸€æ¬¡éå†ï¼Œè®¡ç®—æ‰€æœ‰æ±‡æ€»æŒ‡æ ‡
            const {
                totalPeopleCount,
                totalMeterPaid,
                totalEnergyUsed
            } = currentPeriod.meters.reduce((accumulator, {meterId, currentReading, peopleCount}) => {
                const prev = previousReadingMap[meterId];
                const energy = currentReading - prev;
                accumulator.totalPeopleCount += peopleCount;
                accumulator.totalMeterPaid += energy * unitPrice;
                accumulator.totalEnergyUsed += energy;
                return accumulator;
            }, {
                totalPeopleCount: 0,
                totalMeterPaid: 0,
                totalEnergyUsed: 0
            });
            // è®¡ç®—[å¾…å…¬æ‘Š]
            const totalBillingPaid = currentPeriod.totalBillingPaid;
            const totalPublicPaid = totalBillingPaid - totalMeterPaid;
            const isNegativePublicPaid = totalPublicPaid < 0 && false; //å…¬æ‘Šè´¹æ˜¯å¦<0
            console.log(
                '1ï¼šbillingPeriodDate=', currentPeriod.billingPeriodDate,
                'totalBillingPaid=', totalBillingPaid,
                'meters=', currentPeriod.meters,
                'totalPeopleCount=', totalPeopleCount,
                'totalMeterPaid=', totalMeterPaid.toFixed(2),
                'totalPublicPaid=', totalPublicPaid.toFixed(3),
                'totalEnergyUsed=', totalEnergyUsed.toFixed(1),
                'previousReadingMap=', previousReadingMap,
            );

            //æ¸²æŸ“è¡¨æ ¼
            const block = document.createElement('div');
            block.classList.add('period-block', 'mb-4', 'result-table');
            if (idx % 2 === 0) block.classList.add('odd-period');

            // â€”â€” æ ‡é¢˜ä¸å³ä¾§æ¡£ä½ä¿¡æ¯ï¼ˆä¸¤ç«¯å¯¹é½ï¼‰ â€”â€” //
            const headerRow = document.createElement('div');
            headerRow.className = 'd-flex justify-content-between align-items-center mb-2';
            // å·¦ä¾§ï¼šæ ‡é¢˜ + ç¼©ç•¥å›¾
            const leftWrap = document.createElement('div');
            leftWrap.className = 'd-flex align-items-center';
            const title = document.createElement('h1');
            title.className = 'mb-0';
            title.textContent = `å¸å•æ—¥æœŸï¼š${currentPeriod.billingPeriodDate} ç”µè´¹æ€»é¢ï¿¥ï¼š${currentPeriod.totalBillingPaid.toFixed(2)}`;

            leftWrap.appendChild(title);

            // å³ä¾§ï¼šæ¡£ä½å¾½ç« ï¼ˆå†å²ä»·æˆ–ç¬¬Xæ¡£ï¼‰
            const rightWrap = document.createElement('div');
            const tierText = `ğŸ“Œç¬¬<span class="tier-badge">${tierLabel}</span>æ¡£ (ï¿¥${unitPrice.toFixed(3)} / kWh)`;
            rightWrap.innerHTML = `<span class="">${tierText}</span>`;
            headerRow.appendChild(leftWrap);
            headerRow.appendChild(rightWrap);
            block.appendChild(headerRow);

            const table = document.createElement('table');
            table.classList.add('table', 'table-bordered', 'table-hover');
            let theadHTML = `
            <thead class="thead-dark">
              <tr>
                <th>ç”µè¡¨</th>
                <th>ä¸ŠæœŸè¯»æ•°</th>
                <th>æœ¬æœŸè¯»æ•°</th>
                <th>åº¦æ•°kWh<br><span class="th-info">æœ¬æœŸè¯»æ•°-ä¸ŠæœŸè¯»æ•°</span></th>
                <th>ç”µè¡¨è´¹ï¿¥<br><span class="th-info">åº¦æ•°Ã—<a href="https://m.sh.bendibao.com/news/265282.html" target="_blank">${unitPrice}</a></span></th>
                <th>å¾…å…¬æ‘Šï¿¥<br><span class="th-info">ç”µè´¹æ€»é¢-æ€»ç”µè¡¨è´¹</span></th>
                <th>å…¬æ‘Šè´¹ï¿¥<br><span class="th-info">å¾…å…¬æ‘ŠÃ—<sup>äººæ•°</sup>&frasl;<sub>æ€»äººæ•°</sub></span></th>
                <th>æ€»è´¹ç”¨ï¿¥<br><span class="th-info">ç”µè¡¨è´¹+å…¬æ‘Šè´¹</span></th>
            `;
            if (isNegativePublicPaid) {
                theadHTML += `
                <th>æ€»è´¹ç”¨ï¿¥<br><span class="th-info">æŒ‰ç”¨ç”µæ¯”ï¼Œå…¬æ‘Šè´¹<0æ—¶ä½¿ç”¨</span><br>
                    <span class="th-info">ç”µè´¹æ€»é¢Ã—<sup>åº¦æ•°</sup>&frasl;<sub>æ€»åº¦æ•°</sub></span>
                </th>
            `;
            }
            theadHTML += `</tr></thead><tbody></tbody>`;
            table.innerHTML = theadHTML;
            const tbody = table.querySelector('tbody');
            let totalCombinePaid = 0;
            let totalRatioPaid = 0;
            currentPeriod.meters.forEach((meter, rowIndex) => {
                const meterId = meter.meterId;
                const peopleCount = meter.peopleCount;
                const currentReading = meter.currentReading;//æœ¬æœŸè¯»æ•°
                const previousReading = previousReadingMap[meterId];//ä¸ŠæœŸè¯»æ•°
                const energyUsed = currentReading - previousReading;//ä½¿ç”¨åº¦æ•°
                const meterPaid = energyUsed * unitPrice;//ç”µè¡¨è´¹
                const sharedPaid = totalPublicPaid * peopleCount / totalPeopleCount;//å…¬æ‘Šè´¹
                const combinePaid = sharedPaid + meterPaid;//æŒ‰ï¼šç”µè¡¨è´¹+å…¬æ‘Šè´¹
                totalCombinePaid += combinePaid;
                const ratioPaid = (energyUsed / totalEnergyUsed) * totalBillingPaid;//æŒ‰ï¼šåº¦æ•°/æ€»åº¦æ•°Ã—ç”µè´¹æ€»é¢
                totalRatioPaid += ratioPaid
                console.log(
                    '2:meterId==', meterId,
                    'peopleCount==', peopleCount,
                    'currentReading==', currentReading,
                    'previousReading==', previousReading,
                    'energyUsed==', energyUsed,
                    'meterPaid==', meterPaid.toFixed(3),
                    'sharedPaid==', sharedPaid.toFixed(3),
                    'combinePaid==', combinePaid.toFixed(2),
                    'ratioPaid==', ratioPaid.toFixed(2),
                    'totalBillingPaid==', totalBillingPaid,
                    'totalPublicPaid==', totalPublicPaid.toFixed(3),
                    'totalPeopleCount==', totalPeopleCount
                );
                const alias = meterAliasMap[meterId]
                let rowHTML = `
                    <tr>
                        <td><span>${meterId}</span><br><span class="th-info alias-emphasis">${alias}</span><br><span class="th-info">äººæ•°: ${peopleCount > 1 ? `<span class="people-count-emphasis">${peopleCount}</span>` : peopleCount}</span></td>
                        <td><span class="td-value">${previousReadingMap[meterId]}</span></td>
                        <td><span class="td-value">${currentReading}</span></td>
                        <td><span class="td-value">${energyUsed.toFixed(1)}</span><br><span class="th-info">${currentReading}-${previousReading}</span></td>
                        <td class="meter-paid"><span class="td-value">${meterPaid.toFixed(3)}</span><br><span class="th-info">${energyUsed.toFixed(1)}Ã—${unitPrice}</span></td>
                `;
                // åªåœ¨ç¬¬ä¸€è¡Œè¾“å‡ºå¾…å…¬æ‘Šè¿™ä¸€åˆ—ï¼Œå¹¶åˆå¹¶çºµè·¨ 4 è¡Œ
                if (rowIndex === 0) {
                    rowHTML += `
                        <td rowspan="4" style="vertical-align: middle; text-align: center;">
                            <span class="td-value">${totalPublicPaid.toFixed(3)}</span><br><span class="th-info">${totalBillingPaid.toFixed(2)}-${totalMeterPaid.toFixed(3)}</span>
                        </td>
                    `;
                }
                rowHTML += `
                        <td class="shared-paid"><span class="td-value">${sharedPaid.toFixed(3)}</span><br><span class="th-info">${totalPublicPaid.toFixed(3)}Ã—<sup>${peopleCount > 1 ? `<span class="people-count-emphasis">${peopleCount}</span>` : peopleCount}</sup>&frasl;<sub>${totalPeopleCount}</sub></span></td>
                        <td class="combine-paid"><span class="td-value">${combinePaid.toFixed(2)}</span><br><span class="th-info">${meterPaid.toFixed(3)}+${sharedPaid > 0 ? sharedPaid.toFixed(3) : `(${sharedPaid.toFixed(3)})`}</span></td>
                `;
                if (isNegativePublicPaid) {
                    rowHTML += `
                        <td class="ratio-paid"><span class="td-value">${ratioPaid.toFixed(2)}</span><br><span class="th-info">${totalBillingPaid}Ã—<sup>${energyUsed.toFixed(1)}</sup>&frasl;<sub>${totalEnergyUsed.toFixed(2)}</sub></span></td>
                    `;
                }
                rowHTML += `</tr>`;
                tbody.insertAdjacentHTML('beforeend', rowHTML);
            });
            let totalRowHTML = `
                <tr>
                    <td>æ€»<span class="th-info"><br>äººæ•°: ${totalPeopleCount}</span></td>
                    <td></td>
                    <td></td>
                    <td><span class="td-value">${totalEnergyUsed.toFixed(1)}</span></td>
                    <td><span class="td-value">${totalMeterPaid.toFixed(3)}</span></td>
                    <td></td>
                    <td></td>
                    <td><span class="td-value">${totalCombinePaid.toFixed(2)}</span>${Math.abs(totalCombinePaid - totalBillingPaid) <= 0.000000000001 ? "âœ”" : "âœ–"}</td>

            `;
            if (isNegativePublicPaid) {
                totalRowHTML += `
                <td>${totalRatioPaid.toFixed(2)}</td>
                `;
            }
            totalRowHTML += `</tr>`;
            tbody.insertAdjacentHTML('beforeend', totalRowHTML);
            block.appendChild(table);
            // â€”â€” ä»…åœ¨ isNegativePublicPaid æ—¶æ‰æ˜¾ç¤ºæç¤º â€”â€”
            if (isNegativePublicPaid) {
                const noteWrapper = document.createElement('div');
                noteWrapper.className = 'alert alert-info border-0 rounded-0 mt-2';
                noteWrapper.innerHTML = `
                <div class="d-flex align-items-center">
                  <span class="me-2">ğŸ“Œ</span>
                  <div>
                    æœ¬æœŸç”±äºå…¬æ‘Šè´¹<0ï¼Œ<span class="ratio-info">æŒ‰ç”¨ç”µæ¯”</span>ä»˜è´¹
                  </div>
                </div>
              `;
                block.appendChild(noteWrapper);
            }
            container.appendChild(block);
        });
    }

    window.onload = renderElectricityTable;
</script>

<script>
    let energyChartInstance = null;

    // è‡ªå®šä¹‰æ’ä»¶ï¼šæŒ‰â€œåŒä¸€å¤©çš„ä¸€ç»„æŸ±å­â€èšåˆï¼Œåªåœ¨ç»„ä¸­å¿ƒç”»ä¸€æ¬¡æ—¥æœŸ
    const dateLabelsPlugin = {
        id: 'dateLabelsPlugin',
        afterDatasetsDraw(chart, args, pluginOpts) {
            const {ctx, scales} = chart;
            const yUsage = scales.yUsage;
            if (!yUsage) return;

            // æ”¶é›†æ‰€æœ‰ bar å…ƒç´ ï¼ŒæŒ‰ dateLabel åˆ†ç»„
            const groups = new Map(); // key: dateLabel, value: {xs: [åƒç´ x...]}
            chart.data.datasets.forEach((ds, dsi) => {
                if (ds.type !== 'bar') return;
                const meta = chart.getDatasetMeta(dsi);
                meta.data.forEach((elem, idx) => {
                    const pt = ds.data[idx];
                    if (!pt || pt.y == null) return;         // åªå¯¹çœŸæ­£æœ‰æŸ±å­çš„ç‚¹ç”»æ ‡ç­¾
                    const label = pt.dateLabel;
                    if (!label) return;
                    if (!groups.has(label)) groups.set(label, {xs: []});
                    groups.get(label).xs.push(elem.x);
                });
            });

            if (groups.size === 0) return;

            ctx.save();
            ctx.font = '10px sans-serif';
            ctx.fillStyle = '#000';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';

            const baselineY = yUsage.bottom + 4; // åŸºçº¿ä½ç½®
            groups.forEach(({xs}, label) => {
                // ç»„ä¸­å¿ƒï¼ˆå¯é€‰ï¼šä¹Ÿå¯ç”¨å¹³å‡å€¼ï¼‰
                const centerX = xs.reduce((a, b) => a + b, 0) / xs.length;
                ctx.fillText(label, centerX, baselineY);
            });

            ctx.restore();
        }
    };

    function renderEnergyChart() {
        // ä»…ä¿ç•™æœ€è¿‘periodCountæœŸï¼ˆindex 0 æ˜¯æœ€æ–°ï¼‰
        const periodCount = 6;
        const lastCount = Math.min(periodCount, billingPeriods.length);
        const recentDesc = billingPeriods.slice(0, lastCount); // newest -> older
        const ascPeriods = recentDesc.slice().reverse();       // oldest(å€’æ•°ç¬¬periodCount) -> newest

        const meterIds = ascPeriods[0].meters.map(m => m.meterId);

        // X è½´èŒƒå›´ï¼šçº¿æ€§æ—¶é—´è½´ï¼ˆè· xStart çš„å¤©æ•°ï¼‰
        const DAY_MS = 24 * 60 * 60 * 1000;
        const startRef = new Date(ascPeriods[0].billingPeriodDate);
        const endRef = new Date(recentDesc[0].billingPeriodDate);
        const xStart = startRef;
        const xEnd = endRef;
        const xMin = 0;
        const xMax = Math.ceil((xEnd - xStart) / DAY_MS);

        const dateToDays = (dateStr) => (new Date(dateStr) - xStart) / DAY_MS;

        // æ•°æ®å®¹å™¨
        const readingPointsMap = {};
        const usagePointsMap = {};
        meterIds.forEach(id => {
            readingPointsMap[id] = [];
            usagePointsMap[id] = [];
        });

        // è‹¥è¦ç»™â€œå€’æ•°ç¬¬periodCountæœŸâ€ä¹Ÿè®¡ç®—ç”¨ç”µé‡ï¼Œéœ€è¦çª—å£å¤–ä¸Šä¸€æœŸï¼ˆæ›´æ—©ä¸€æœŸï¼‰
        const prevForFirst = billingPeriods.length > lastCount ? billingPeriods[lastCount] : null;
        let prevFirstMap = null;
        if (prevForFirst) {
            prevFirstMap = {};
            prevForFirst.meters.forEach(m => (prevFirstMap[m.meterId] = m.currentReading));
        }

        // æ„é€ æŠ˜çº¿(ç´¯è®¡è¯»æ•°) & æŸ±(Î”kWh)
        for (let i = 0; i < ascPeriods.length; i++) {
            const period = ascPeriods[i];
            const xDays = dateToDays(period.billingPeriodDate);

            const currMap = {};
            period.meters.forEach(m => (currMap[m.meterId] = m.currentReading));

            // æŠ˜çº¿ï¼šç´¯è®¡è¯»æ•°
            period.meters.forEach(m => {
                readingPointsMap[m.meterId].push({
                    x: xDays,
                    y: +m.currentReading.toFixed(1)
                });
            });

            // Î”kWhï¼ši==0 ç”¨çª—å£å¤–ä¸Šä¸€æœŸï¼ˆè‹¥æœ‰ï¼‰ï¼›i>0 ç”¨ ascPeriods[i-1]
            if (i === 0) {
                if (prevFirstMap) {
                    meterIds.forEach(id => {
                        const used = currMap[id] - prevFirstMap[id];
                        usagePointsMap[id].push({
                            x: xDays,
                            y: +used.toFixed(1),
                            dateLabel: period.billingPeriodDate   // è´¦å•æ—¥æœŸç”¨äºç”»æ ‡ç­¾
                        });
                    });
                } // æ²¡æœ‰å¤–éƒ¨ä¸Šä¸€æœŸæ—¶ï¼Œä¸ç”ŸæˆæŸ±å­ï¼Œä¹Ÿå°±ä¸ç”»è¯¥æœŸæ—¥æœŸ
            } else {
                const prev = ascPeriods[i - 1];
                const prevMap = {};
                prev.meters.forEach(m => (prevMap[m.meterId] = m.currentReading));
                meterIds.forEach(id => {
                    const used = currMap[id] - prevMap[id];
                    usagePointsMap[id].push({
                        x: xDays,
                        y: +used.toFixed(1),
                        dateLabel: period.billingPeriodDate
                    });
                });
            }
        }

        // é¢œè‰²
        const lineColors = ['rgb(255,99,132)', 'rgb(54,162,235)', 'rgb(75,192,192)', 'rgb(255,159,64)'];
        const barFills = ['rgba(255,99,132,0.25)', 'rgba(54,162,235,0.25)', 'rgba(75,192,192,0.25)', 'rgba(255,159,64,0.25)'];
        const barBorders = ['rgba(255,99,132,0.9)', 'rgba(54,162,235,0.9)', 'rgba(75,192,192,0.9)', 'rgba(255,159,64,0.9)'];

        // ç»„è£… datasets
        const datasets = [];
        meterIds.forEach((id, i) => {
            // æŠ˜çº¿
            datasets.push({
                label: `${id}ï¼ˆè¯»æ•°ï¼‰`,
                type: 'line',
                yAxisID: 'yReading',
                data: readingPointsMap[id],
                fill: false,
                tension: 0.35,
                pointRadius: 3,
                borderWidth: 2,
                borderColor: lineColors[i],
                backgroundColor: lineColors[i],
                parsing: false,
            });
            // æŸ±
            datasets.push({
                label: `${id}ï¼ˆç”¨ç”µé‡ï¼‰`,
                type: 'bar',
                yAxisID: 'yUsage',
                data: usagePointsMap[id],
                borderWidth: 1,
                borderColor: barBorders[i],
                backgroundColor: barFills[i],
                parsing: false,
                barPercentage: 0.9,
                categoryPercentage: 0.9
            });
        });

        if (energyChartInstance) energyChartInstance.destroy();

        const ctx = document.getElementById('energyChart').getContext('2d');
        energyChartInstance = new Chart(ctx, {
            data: {datasets},
            options: {
                responsive: true,
                maintainAspectRatio: false,
                parsing: false,
                interaction: {mode: 'nearest', intersect: false},
                layout: {padding: {bottom: 22}}, // ç»™æ—¥æœŸæ ‡ç­¾ç•™ç©ºé—´
                scales: {
                    x: {
                        type: 'linear',
                        min: xMin,
                        max: xMax,
                        // éšè—åŸæœ‰ X è½´åˆ»åº¦ä¸æ–‡å­—
                        ticks: {display: false},
                        grid: {drawOnChartArea: true, drawTicks: false}
                    },
                    yUsage: {
                        position: 'right',
                        beginAtZero: true,
                        title: {display: true, text: 'ç”¨ç”µé‡kWh'},
                        grid: {drawOnChartArea: true}
                    },
                    yReading: {
                        position: 'left',
                        title: {display: true, text: 'ç”µè¡¨è¯»æ•°'},
                        grid: {drawOnChartArea: false}
                    }
                },
                plugins: {
                    title: {display: true, text: 'è¿‘' + periodCount + 'æœŸç”¨ç”µå˜åŒ–'},
                    legend: {position: 'top'},
                    tooltip: {
                        callbacks: {
                            // æç¤ºæ¡†ä»ç”¨æ—¥æœŸï¼Œä¾¿äºæŸ¥çœ‹
                            title: (items) => {
                                const ds = items[0].dataset;
                                const i = items[0].dataIndex;
                                const d = ds.data?.[i]?.dateLabel;
                                if (d) return d;
                                // æŠ˜çº¿ç‚¹æ²¡æœ‰ dateLabelï¼Œç”¨çº¿æ€§åˆ»åº¦åæ¨
                                const DAY_MS = 24 * 60 * 60 * 1000;
                                const xStart = new Date(ascPeriods[0].billingPeriodDate);
                                const d2 = new Date(xStart.getTime() + Math.round(items[0].parsed.x) * DAY_MS);
                                const yyyy = d2.getFullYear();
                                const mm = String(d2.getMonth() + 1).padStart(2, '0');
                                const dd = String(d2.getDate()).padStart(2, '0');
                                return `${yyyy}-${mm}-${dd}`;
                            },
                            label: (item) => {
                                const name = item.dataset.label || '';
                                const y = item.parsed.y;
                                return item.dataset.yAxisID === 'yUsage' ? `${name}: ${y} kWh` : `${name}: ${y}`;
                            }
                        }
                    }
                }
            },
            plugins: [dateLabelsPlugin]
        });
    }
</script>
<script>
    function prefillAddForm() {
        const form = document.getElementById('addPeriodForm');
        if (!form || !billingPeriods || billingPeriods.length === 0) return;

        const setBoth = (input, val) => {
            input.value = val;
            input.defaultValue = val; // å…³é”®ï¼šæ›´æ–°é»˜è®¤å€¼ï¼Œé¿å… reset å›åˆ°å†™æ­»å€¼
        };

        const last = billingPeriods[0];
        const DAY_MS = 24 * 60 * 60 * 1000;

        const lastDate = new Date(last.billingPeriodDate);
        const nextDate = new Date(lastDate.getTime() + 40 * DAY_MS);
        const yyyy = nextDate.getFullYear();
        const mm = String(nextDate.getMonth() + 1).padStart(2, '0');
        const dd = String(nextDate.getDate()).padStart(2, '0');
        setBoth(form.billingDate, `${yyyy}-${mm}-${dd}`);

        // ä½ ä¹Ÿå¯ä»¥é€‰æ‹©æŠŠâ€œç”µè´¹æ€»é¢â€åŒæ­¥æ›´æ–°ä¸ºä¸ŠæœŸæˆ–æ¸…ç©ºï¼Œè¿™é‡Œç¤ºä¾‹ï¼šä¿ç•™å½“å‰å€¼ä¸åŠ¨
        // setBoth(form.totalPaid, form.totalPaid.value);

        const lastMap = {};
        (last.meters || []).forEach(m => lastMap[m.meterId] = m);

        const inc = () => 200 + Math.random() * 80;
        const addDelta = (base) => +(base + inc()).toFixed(1);

        if (lastMap['1å·è¡¨']) {
            setBoth(form.m1Reading, addDelta(parseFloat(lastMap['1å·è¡¨'].currentReading)));
            setBoth(form.m1Count, (lastMap['1å·è¡¨'].peopleCount ?? 1).toString());
        }
        if (lastMap['2å·è¡¨']) {
            setBoth(form.m2Reading, addDelta(parseFloat(lastMap['2å·è¡¨'].currentReading)));
            setBoth(form.m2Count, (lastMap['2å·è¡¨'].peopleCount ?? 1).toString());
        }
        if (lastMap['3å·è¡¨']) {
            setBoth(form.m3Reading, addDelta(parseFloat(lastMap['3å·è¡¨'].currentReading)));
            setBoth(form.m3Count, (lastMap['3å·è¡¨'].peopleCount ?? 1).toString());
        }
        if (lastMap['4å·è¡¨']) {
            setBoth(form.m4Reading, addDelta(parseFloat(lastMap['4å·è¡¨'].currentReading)));
            setBoth(form.m4Count, (lastMap['4å·è¡¨'].peopleCount ?? 1).toString());
        }
    }
</script>
<!-- â†‘â†‘â†‘ è¡¨å•ç»“æŸ â†‘â†‘â†‘ -->
<script>
    document.getElementById('addPeriodForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const form = e.target;

        // å–å€¼
        const billingDate = form.billingDate.value; // YYYY-MM-DD
        const totalPaid = parseFloat(form.totalPaid.value);
        const tier = form.priceTier.value;  // è·å–æ¡£ä½

        // å››ä¸ªç”µè¡¨æ•°æ®
        const newMeters = [];
        for (let i = 1; i <= 4; i++) {
            const reading = parseFloat(form[`m${i}Reading`].value);
            const count = parseInt(form[`m${i}Count`].value, 10);
            newMeters.push({
                meterId: `${i}å·è¡¨`,
                currentReading: reading,
                peopleCount: count
            });
        }

        // æ„é€ æ–°è´¦å•å¯¹è±¡
        const newPeriod = {
            billingPeriodDate: billingDate,
            totalBillingPaid: totalPaid,
            tier: tier,
            meters: newMeters
        };

        // æ’å…¥æœ€å‰é¢ï¼Œä½œä¸ºæœ€æ–°ä¸€æœŸ
        billingPeriods.unshift(newPeriod);

        // é‡æ–°æ¸²æŸ“è¡¨æ ¼å’Œå›¾è¡¨
        renderElectricityTable();
        renderEnergyChart();

        // æ¸…ç©ºè¡¨å•
        form.reset();
        prefillAddForm();
    });
    document.getElementById('downloadDataBtn').addEventListener('click', function () {
        // 1. åºåˆ—åŒ–å½“å‰çš„ billingPeriods
        const jsonStr = JSON.stringify(billingPeriods, null, 2);
        // 2. ç”Ÿæˆä¸€ä¸ª Blob
        const blob = new Blob([jsonStr], {type: 'application/json'});
        // 3. åˆ›å»ºä¸€ä¸ªä¸´æ—¶ä¸‹è½½é“¾æ¥
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'billingPeriods.json'; // ä¸‹è½½æ–‡ä»¶å
        // 4. è§¦å‘ç‚¹å‡»
        a.click();
        // 5. æ¸…ç†
        URL.revokeObjectURL(url);
    });
    // é¡µé¢åŠ è½½æ—¶æ¸²æŸ“
    window.onload = function () {
        renderElectricityTable();
        renderEnergyChart();
        prefillAddForm();
    };
</script>
</body>
</html>
